<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>客製化月曆</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        padding: 0;
        margin: 0;
        min-height: 100svh;
      }
      * {
        box-sizing: border-box;
        font-family: sans-serif;
      }
      :root {
        --nav-height: 60px;
        --week-height: 30px;
        --date-height: 50px;
      }
      .datepicker {
        position: relative;
        width: 200px;
        height: 24px;
        & input {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
        }
        .icon {
          position: absolute;
          right: 4px;
          top: 4px;
        }
      }

      .calendarContainer {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        /* background-color: #515151; */
        z-index: 1;
        display: none;

        .calendar {
          background-color: #18a1ff;
          width: 400px;
          height: fit-content;
          border: 1px solid gray;

          .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--nav-height);
            .btn {
              width: 24px;
              height: 24px;
              border-radius: 5px;
              background-color: #fff;
              cursor: pointer;
              display: flex;
              justify-content: center;
              align-items: center;
            }
          }

          .week {
            font-weight: bold;
            height: var(--week-height);
          }

          .weekday {
            user-select: none;
          }

          .dates {
            background-color: #fff;
            .date {
              padding: 8px;
              cursor: pointer;
              user-select: none;
              height: var(--date-height);
              &:hover {
                background-color: #faad14;
              }
            }

            .currentDate {
              background-color: #1581cc;
              /* border-radius: 10px; */
            }

            .disabled {
              background-color: #909090;
              color: #515151;
              cursor: not-allowed;
              &:hover {
                background-color: #909090;
                color: #515151;
              }
            }
          }

          .unit1 {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
          }
        }
      }
      .calendarContainer.active {
        display: flex;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <div class="datepicker">
      <input type="text" />
      <i class="fa-solid fa-calendar icon"></i>
    </div>
    <div class="calendarContainer">
      <div class="calendar">
        <div class="nav">
          <div class="btn btnLeft">
            <i class="fa-solid fa-caret-left"></i>
          </div>
          <div class="month">2024-02</div>
          <div class="btn btnRight">
            <i class="fa-solid fa-caret-right"></i>
          </div>
        </div>
        <div class="week unit1">
          <div class="weekday">Sun</div>
          <div class="weekday">Mon</div>
          <div class="weekday">Tue</div>
          <div class="weekday">Wed</div>
          <div class="weekday">Thu</div>
          <div class="weekday">Fri</div>
          <div class="weekday">Sat</div>
        </div>
        <div class="dates unit1"></div>
      </div>
    </div>

    <script>
      const divMonth = document.querySelector(".month");
      const divDates = document.querySelector(".dates");
      const divCalendarContainer = document.querySelector(".calendarContainer");
      const btnLeft = document.querySelector(".btnLeft");
      const btnRight = document.querySelector(".btnRight");
      const inputDate = document.querySelector(".datepicker input");
      const datepicker = document.querySelector(".datepicker");
      // 視窗高度
      const wHeight = window.innerHeight;

      const disabledArr = ["2024-02-20", "2024-02-29"];

      let currentDate = new Date();

      datepicker.addEventListener("click", () => {
        divCalendarContainer.classList.add("active");
      });

      divCalendarContainer.addEventListener("click", (e) => {
        if (e.target.classList.contains("disabled")) {
          return false;
        }
        if (e.target.classList.contains("date")) {
          let yy = e.target.getAttribute("y");
          let mm = e.target.getAttribute("m");
          let dd = e.target.getAttribute("d");
          console.log(`${yy}-${mm}-${dd}`);
          inputDate.value = `${yy}-${mm}-${dd}`;
          //   選擇日期後，關閉月曆介面
          divCalendarContainer.classList.remove("active");
        } else if (
          // 避免切換月份時，關閉月曆介面
          e.target.classList.contains("btnLeft") ||
          e.target.classList.contains("fa-caret-left") ||
          e.target.classList.contains("btnRight") ||
          e.target.classList.contains("fa-caret-right")
        ) {
        } else {
          // 點擊任一處，關閉月曆介面(因為月曆佔據整個畫面)
          divCalendarContainer.classList.remove("active");
        }
      });

      //  上個月
      btnLeft.addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      });

      //  下個月
      btnRight.addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      });

      renderCalendar();

      function renderCalendar() {
        // 日期區塊初始化，避免元素持續append
        divDates.innerHTML = "";

        let totalWeeks = weeksInMonth(currentDate.getFullYear(), currentDate.getMonth());
        // 計算每個日期區塊的高度，先減去月份(nav 60px)和星期資訊(week 30px)的高度
        // 然後把剩餘的視窗高度 / 週數使之平均分配
        let dateHeight = Math.floor((wHeight - 60 - 30)/totalWeeks);
        document.documentElement.style.setProperty('--date-height', dateHeight+'px')
        console.log(dateHeight);
        // 取得年、月
        let cY = currentDate.getFullYear();
        let cM = currentDate.toLocaleString("zh-TW", { month: "long" });
        divMonth.innerHTML = `${cY}年 ${cM}`;
        // 只要月份 {month: 'long'}
        // console.log(currentDate.toLocaleString('zh-TW', {month: 'long'}));

        // 製造出月曆上空著的部分
        let firstDate = new Date(
          currentDate.getFullYear(),
          currentDate.getMonth(),
          1
        );
        let firstDay = firstDate.getDay();
        for (let i = 0; i < firstDay; i++) {
          const node = document.createElement("div");
          // node.innerHTML
          divDates.append(node);
        }

        // Date(year, month+1, 0) 表示下個月(month+1)第一天的上一天(0) = 這個月的最後一天
        let totalDays = new Date(
          currentDate.getFullYear(),
          currentDate.getMonth() + 1,
          0
        ).getDate();
        for (let i = 1; i <= totalDays; i++) {
          const node = document.createElement("div");
          const dd = i.toString().padStart(2, "0");
          const mm = (currentDate.getMonth() + 1).toString().padStart(2, "0");
          const yy = currentDate.getFullYear();
          node.innerHTML = `<div class="date" y="${yy}" m="${mm}" d="${dd}">${i}</div>`;

          // 若年月日相同，加上當天的特別樣式
          if (
            i === new Date().getDate() &&
            currentDate.getMonth() === new Date().getMonth() &&
            currentDate.getFullYear() === new Date().getFullYear()
          ) {
            node.children[0].classList.add("currentDate");
          }

          // 若年月日相同，加上無法選擇的特別樣式
          disabledArr.map((d) => {
            let date1 = new Date(d);
            let date2 = new Date(
              currentDate.getFullYear(),
              currentDate.getMonth(),
              i
            );
            if (
              date1.getDate() === date2.getDate() &&
              date1.getMonth() === date2.getMonth() &&
              date1.getFullYear() === date2.getFullYear()
            ) {
              node.children[0].classList.add("disabled");
            }
          });

          // 加入date區塊到dates中
          divDates.append(node.children[0]);
        }
      }

      // 計算該月份的週數
      function weeksInMonth(year, month) {
        // 當月第一天
        const firstDateOfMonth = new Date(year, month);
        // 當月最後一天
        const lastDateOfMonth = new Date(year, month + 1, 0);
        // 當月第一天的星期
        const firstDayOfMonth = firstDateOfMonth.getDay();
        // 一個月的總天數
        const totalDays = lastDateOfMonth.getDate();
        // 第一週的天數
        const daysInFirstWeek = (firstDayOfMonth === 0) ? 0 : 7-firstDayOfMonth;
        // 去除第一週後剩餘的天數
        const otherDays = totalDays - daysInFirstWeek;
        // 四捨五入得出週數
        const weeks = Math.ceil(otherDays / 7);
        const totalWeeks = weeks + ((daysInFirstWeek > 0) ? 1: 0);
        // console.log(totalWeeks);
        return totalWeeks;
      }
    </script>
  </body>
</html>
