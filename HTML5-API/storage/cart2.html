<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>購物車2 商品詳細</title>
    <style>
      .product {
        display: flex;
        margin-bottom: 10px;
      }

      .product .img {
        width: 200px;
        height: 200px;
      }

      .product .img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .product .name {
        font-size: 20px;
        padding-left: 10px;
      }

      .cart {
        position: fixed;
        right: 0;
        bottom: 10px;
        font-size: 24px;
        background-color: crimson;
        color: white;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <h1>商品詳細</h1>
    <div class="product">
      <div class="img">
        <img src="" alt="" />
      </div>
      <div class="content">
        <h2>NAME</h2>
        <div class="price">100</div>
        <input type="number" value="0" name="amount" />
        <button>+</button>
        <br />
        <a href="./cart1.html">Back</a>
      </div>
    </div>
    <a href="./cart3.html">
      <div class="cart">0</div>
    </a>

    <script>
      // 網址中，?後的參數全部都是search
      let queryString = window.location.search;
      // ?id=357756
      // console.log(queryString);
      let urlParams = new URLSearchParams(queryString);
      // 357756
      let id = parseInt(urlParams.get("id"), 10);

      const img = document.querySelector(".img img");
      const divName = document.querySelector("h2");
      const divPrice = document.querySelector(".price");
      const addBtn = document.querySelector("button");
      const divCart = document.querySelector(".cart");
      let cartArr = [];

      // 預防填入無法解析的資料
      try {
        cartArr = JSON.parse(localStorage.getItem("cart"));
      } catch (error) {
        console.log(error);
        cartArr = [];
        localStorage.clear();
      }

      if (!cartArr) {
        cartArr = [];
      }
      divCart.innerHTML = cartArr.length;

      addBtn.addEventListener("click", (e) => {
        let amount = parseInt(
          document.querySelector("[name=amount]").value,
          10
        );
        if (amount <= 0) {
          return false;
        }
        // 檢查購物車中是否已存在該商品
        let item = cartArr.find((p) => p.id === id);
        if (item) {
          // 存在，增加數量
          item.amount += amount;
        } else {
          // 不存在，定義物件的值
          item = { id, amount };
          // 把物件新增進購物車
          cartArr.push(item);
        }
        console.log(cartArr);
        // 更新購買商品種類數量
        divCart.innerHTML = cartArr.length;
        // 更新cart內容
        localStorage.setItem("cart", JSON.stringify(cartArr));
      });

      let getData = () => {
        return new Promise((resolve, reject) => {
          let url = "./products.json";
          fetch(url)
            .then((response) => {
              return response.json();
            })
            .then((result) => {
              return resolve(result);
            })
            .catch((error) => {
              console.log(error);
              return reject(undefined);
            });
        });
      };

      (async () => {
        let datas = await getData();
        // filter回傳陣列
        // let data1 = datas.products.filter(p => p.id === id);
        // find若結果只有一筆，回傳單一元素，此例中是物件
        let data = datas.products.find((p) => p.id === id);
        img.setAttribute("src", data.img);
        divName.innerHTML = data.name;
        divPrice.innerHTML = data.price;
      })();
    </script>
  </body>
</html>
