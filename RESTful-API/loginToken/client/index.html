<!doctype html>
<html lang="en">
    <head>
        <title>Title</title>
        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />

        <!-- Bootstrap CSS v5.2.1 -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous"/>
    </head>

    <body>
        <div class="container mt-3">
            <div class="form">
                <div class="input-group mb-2">
                    <span class="input-group-text">帳號</span>
                    <input type="text" class="form-control" name="account">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">密碼</span>
                    <input type="password" class="form-control" name="password">
                </div>
                <div class="d-flex justify-content-end">
                    <div class="btn btn-primary btn-login">登入</div>
                </div>
            </div>
            
            <div class="main d-none">
                <h1>NAME_HERE</h1>
                <div class="img">
                    <img src="" alt="head img here">
                </div>
                <div class="fs-3 account">ACCOUNT_HERE</div>
                <div class="mail">MAIL_HERE</div>
                <div class="d-flex justify-content-end">
                    <div class="btn btn-primary btn-logout">登出</div>
                </div>
            </div>
        </div>

        <!-- jQuery & jwt -->
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

        <script>
            // 內容同secretKey
            const appKey = 'iamantonio';
            let user, token;
            // 初始化
            init();

            $('.btn-login').on('click', e => {
                let url = 'http://localhost:3000/api/users/login';
                const account = $('[name=account]').val();
                const password = $('[name=password]').val();
                // 目的地, 傳出資料, 回傳資料
                $.post(url, {account, password}, data => {
                    token = data.token;
                    user = jwt_decode(token);
                    // 把token儲存在客戶端本地
                    localStorage.setItem("token", token);
                    setMain();
                }).fail(error => {
                    alert(error.responseJSON.message);
                })
            });
            $('.btn-logout').on('click', e => {
                let url = 'http://localhost:3000/api/users/logout'
                $.ajax({
                    url: url,
                    type: 'POST',
                    headers: {
                        Authorization: `Bearer ${token}`
                    },
                    success: data => {
                        token = null;
                        localStorage.removeItem('token');
                        user = undefined;
                        setForm();
                    },
                    error: (p1, p2, p3) => {
                        console.log(p3);
                        setForm();
                    }
                });
            });

            // 檢查登入狀態，並初始化
            function init(){
                token = localStorage.getItem('token');
                if (token) {
                    let url = 'http://localhost:3000/api/users/status';
                    $.ajax({
                        url: url,
                        type: 'POST',
                        // 設定Authorization的值
                        headers: {
                            Authorization: `Bearer ${token}`
                        },
                        success: data => {
                            // 傳入status檢查後，更新toekn(多了Bearer )
                            token = data.token;
                            localStorage.setItem('token', token);
                            user = jwt_decode(token);
                            setMain();
                        },
                        error: (p1, p2, p3) => {
                            console.log(p3);
                            setForm();
                        }
                    });
                } else {
                    // 無token時，顯示表單
                    setForm();
                }
            }

            function setMain(){
                $('.main h1').html(user.name);
                $('.main .account').html(user.account);
                $('.main .mail').html(user.mail);
                $('.main .img img').attr('src', user.head);
                $(".form").addClass('d-none');
                $('.main').removeClass('d-none');
            }

            function setForm(){
                // 清空表單內容，並顯示表單
                $('input[name=account]').val('');
                $('input[name=password]').val('');
                $(".form").removeClass('d-none');
                $('.main').addClass('d-none');
            }
        </script>
    </body>
</html>
